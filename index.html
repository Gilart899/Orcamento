<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="GilFest — Ferramenta de orçamento e contrato com assinatura digital e exportação em PDF">
  <title>GilFest — Orçamentos & Contratos</title>

  <!-- Estilos -->
  <style>
  :root{
    --gap: 12px;
    --accent: #0d6efd;
    --muted: #666;
    --bg: #fff;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, sans-serif; margin:0; background:#f7f7f8; color:#222}
  .container{max-width:980px;margin:20px auto;padding:16px;background:var(--bg);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .header{display:flex;gap:12px;align-items:center;margin-bottom:10px}
  .logo{width:64px;height:auto}
  h1{font-size:1.25rem;margin:0}
  .lead{margin:0;color:var(--muted);font-size:.95rem}
  section{margin-top:20px}
  h2{font-size:1.1rem;margin:10px 0}
  .row{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
  label{font-size:.85rem;color:var(--muted);display:block}
  input[type="text"], input[type="number"], input[type="date"], input[type="tel"], .qty-input{padding:8px;border-radius:6px;border:1px solid #ddd;width:100%}
  .actions{display:flex;flex-direction:column;gap:8px;margin-top:16px}
  .actions button{padding:10px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .actions button:hover{opacity:.9}
  .categoria{margin-top:10px}
  .item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fafafa;margin-top:6px}
  .item label{flex:1}
  .qty{display:flex;align-items:center;gap:6px}
  .qty button{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
  .preco{min-width:80px;text-align:right;color:var(--muted)}
  #resumo{background:#f1f3f9;padding:12px;border-radius:8px}
  #signature-pad{border:1px solid #ccc;border-radius:6px;width:100%;max-width:600px}
  .sigActions{margin-top:6px;display:flex;gap:8px}
  .sigActions button{background:#aaa;color:#fff;padding:6px 12px;border-radius:6px;border:0;cursor:pointer}
  @media(min-width:720px){
    .row{grid-template-columns:repeat(3,1fr)}
    .actions{flex-direction:row}
  }
  </style>
</head>
<body>
<main class="container">
  <header class="header">
    <img src="logo.png" alt="LOGO GilFest" class="logo" />
    <div>
      <h1>GilFest — Orçamentos & Contratos</h1>
      <p class="lead">Gere orçamento e contrato com assinatura digital e exporte em PDF.</p>
    </div>
  </header>

  <form id="orcamentoForm" novalidate>
    <section aria-labelledby="cliente-title">
      <h2 id="cliente-title">Dados do Cliente</h2>
      <div class="row">
        <div>
          <label for="clienteNome">Nome</label>
          <input id="clienteNome" name="clienteNome" type="text" placeholder="Ex: João Silva" required />
        </div>
        <div>
          <label for="clienteTelefone">Telefone</label>
          <input id="clienteTelefone" name="clienteTelefone" type="tel" placeholder="(99) 99999-9999" />
        </div>
        <div>
          <label for="dataEmissao">Data de emissão</label>
          <input id="dataEmissao" name="dataEmissao" type="date" />
        </div>
      </div>
    </section>

    <section aria-labelledby="config-title">
      <h2 id="config-title">Configurações</h2>
      <div class="row">
        <div>
          <label for="valorHoraExtra">Valor hora extra (R$)</label>
          <input id="valorHoraExtra" name="valorHoraExtra" type="number" min="0" step="0.01" value="0" />
        </div>
        <div>
          <label for="percentualSinal">Percentual de sinal (%)</label>
          <input id="percentualSinal" name="percentualSinal" type="number" min="0" max="100" value="20" />
        </div>
      </div>
    </section>

    <section aria-labelledby="servicos-title" id="servicos">
      <h2 id="servicos-title">Serviços</h2>

      <div class="categoria">
        <h3>Comidas e Guloseimas</h3>
        <div class="item" data-preco="2.5">
          <label><input type="checkbox" class="item-checkbox" /> Algodão doce no copo (300ml)</label>
          <div class="qty">
            <button type="button" class="qty-dec">−</button>
            <input type="number" class="qty-input" value="0" min="0" />
            <button type="button" class="qty-inc">+</button>
          </div>
          <div class="preco">R$ 2,50</div>
        </div>
        <div class="item" data-preco="1200">
          <label><input type="checkbox" class="item-checkbox" /> Cascata de chocolate — grande</label>
          <div class="qty">
            <button type="button" class="qty-dec">−</button>
            <input type="number" class="qty-input" value="0" min="0" />
            <button type="button" class="qty-inc">+</button>
          </div>
          <div class="preco">R$ 1.200,00</div>
        </div>
      </div>
    </section>

    <section id="resumo" aria-live="polite">
      <h2>Resumo</h2>
      <div id="total">Total calculado: R$ <span id="totalValue">0,00</span></div>
      <div id="sinalInfo">Sinal: R$ <span id="sinalValue">0,00</span> • Saldo: R$ <span id="saldoValue">0,00</span></div>
    </section>

    <div class="actions">
      <button id="gerarOrcamento" type="button">Gerar Orçamento (PDF)</button>
      <button id="gerarContrato" type="button">Gerar Contrato (PDF)</button>
      <button id="enviarWhats" type="button">Enviar pelo WhatsApp</button>
    </div>
  </form>

  <section id="assinaturaSection">
    <h2>Assinatura digital (cliente)</h2>
    <canvas id="signature-pad" width=600 height=200 aria-label="Área para assinatura"></canvas>
    <div class="sigActions">
      <button id="clearSig" type="button">Limpar assinatura</button>
      <button id="saveSig" type="button">Salvar assinatura</button>
    </div>
  </section>
</main>

<!-- Libs externas -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const itens = Array.from(document.querySelectorAll('.item'));
  const totalValueEl = document.getElementById('totalValue');
  const sinalValEl = document.getElementById('sinalValue');
  const saldoValEl = document.getElementById('saldoValue');
  const percentualInput = document.getElementById('percentualSinal');
  const valorHoraExtraInput = document.getElementById('valorHoraExtra');

  function parsePrice(v){ return Number(String(v).replace(',','.')) || 0 }
  function currencyBr(v){ return v.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) }

  function getItemData(itemEl){
    const preco = parsePrice(itemEl.dataset.preco);
    const qty = Number(itemEl.querySelector('.qty-input').value) || 0;
    return { preco, qty, total: preco*qty, nome: itemEl.querySelector('label').textContent.trim() };
  }

  function calcular(){
    let subtotal=0;
    itens.forEach(item=>{
      if(item.querySelector('.item-checkbox').checked){
        subtotal+= getItemData(item).total;
      }
    });
    const percentual = Number(percentualInput.value)||0;
    const sinal = subtotal*percentual/100;
    const saldo = subtotal-sinal;
    totalValueEl.textContent = currencyBr(subtotal);
    sinalValEl.textContent = currencyBr(sinal);
    saldoValEl.textContent = currencyBr(saldo);
  }

  itens.forEach(item=>{
    const inc=item.querySelector('.qty-inc');
    const dec=item.querySelector('.qty-dec');
    const qty=item.querySelector('.qty-input');
    const chk=item.querySelector('.item-checkbox');
    inc.addEventListener('click',()=>{qty.value=Number(qty.value||0)+1;calcular()});
    dec.addEventListener('click',()=>{qty.value=Math.max(0,Number(qty.value||0)-1);calcular()});
    qty.addEventListener('input',calcular);
    chk.addEventListener('change',calcular);
  });
  percentualInput.addEventListener('input',calcular);
  valorHoraExtraInput.addEventListener('input',calcular);
  calcular();

  // assinatura digital
  const canvas=document.getElementById('signature-pad');
  const signaturePad=new SignaturePad(canvas,{backgroundColor:'rgba(255,255,255,0)', penColor:'rgb(0,0,0)'});
  document.getElementById('clearSig').addEventListener('click',()=>{signaturePad.clear();window.__sigData=null});
  document.getElementById('saveSig').addEventListener('click',()=>{
    if(signaturePad.isEmpty()){alert('Assine primeiro.');return}
    window.__sigData=signaturePad.toDataURL('image/png');
    alert('Assinatura salva!');
  });

  // gerar PDF
  document.getElementById('gerarOrcamento').addEventListener('click',()=>gerarPDF(false));
  document.getElementById('gerarContrato').addEventListener('click',()=>gerarPDF(true));

  function gerarPDF(comContrato){
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF({unit:'pt', format:'a4'});
    const cliente=document.getElementById('clienteNome').value||'Cliente';
    doc.setFontSize(14);
    doc.text(comContrato?'Contrato de Prestação de Serviços':'Orçamento',40,40);
    doc.setFontSize(12);
    doc.text(`Cliente: ${cliente}`,40,60);

    const selecionados=itens.map(getItemData).filter((it,idx)=>it.qty>0&&itens[idx].querySelector('.item-checkbox').checked);
    if(selecionados.length){
      const table=selecionados.map(it=>[it.nome,it.qty,`R$ ${currencyBr(it.preco)}`,`R$ ${currencyBr(it.total)}`]);
      doc.autoTable({startY:90, head:[['Item','Qtd','Unitário','Total']], body:table, styles:{fontSize:10}});
    }
    const subtotal=selecionados.reduce((s,i)=>s+i.total,0);
    const percentual=Number(percentualInput.value)||0;
    const sinal=subtotal*percentual/100;
    const saldo=subtotal-sinal;
    const finalY=doc.lastAutoTable?.finalY||150;
    doc.text(`Subtotal: R$ ${currencyBr(subtotal)}`,40,finalY+20);
    doc.text(`Sinal (${percentual}%): R$ ${currencyBr(sinal)}`,40,finalY+35);
    doc.text(`Saldo: R$ ${currencyBr(saldo)}`,40,finalY+50);

    if(comContrato){
      doc.text('Cláusulas básicas do contrato:',40,finalY+80);
      doc.setFontSize(10);
      doc.text('1. O contratado se compromete a fornecer os serviços listados.\n2. O cliente deve pagar o sinal e saldo conforme acordado.\n3. Em caso de cancelamento, condições de reembolso serão aplicadas.\n4. Ambas as partes concordam com as responsabilidades definidas.',40,finalY+100,{maxWidth:500});
    }

    if(window.__sigData){
      doc.setFontSize(12);
      doc.text('Assinatura do Cliente:',40,finalY+200);
      doc.addImage(window.__sigData,'PNG',40,finalY+210,200,60);
    }

    doc.save(`${comContrato?'Contrato':'Orcamento'}-${cliente.replace(/\s+/g,'_')}.pdf`);
  }

  // envio WhatsApp
  document.getElementById('enviarWhats').addEventListener('click',()=>{
    const cliente=document.getElementById('clienteNome').value||'Cliente';
    const total=totalValueEl.textContent;
    const msg=`Olá ${cliente}, segue o orçamento.\nValor total: R$ ${total}`;
    const url=`https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  });
});
</script>
</body>
</html>
